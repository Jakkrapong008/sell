<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡πÑ‡∏°‡πâ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0fdf4; /* Light green pastel */
        }
        .pastel-primary { background-color: #a7f3d0; } /* Mint */
        .pastel-secondary { background-color: #fef3c7; } /* Pale Yellow */
        .pastel-accent { background-color: #fbcfe8; } /* Pink */
        .btn-primary {
            background-color: #34d399; /* Emerald */
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover { background-color: #10b981; }
        .btn-secondary {
            background-color: #fbbf24; /* Amber */
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover { background-color: #f59e0b; }
        .btn-danger {
            background-color: #f87171; /* Red */
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-danger:hover { background-color: #ef4444; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in-up { animation: slideInUp 0.5s ease-out forwards; }

        /* Custom scrollbar for product list if it overflows */
        .product-list::-webkit-scrollbar {
            width: 8px;
        }
        .product-list::-webkit-scrollbar-track {
            background: #f0fdf4; /* Light green pastel */
        }
        .product-list::-webkit-scrollbar-thumb {
            background: #a7f3d0; /* Mint */
            border-radius: 4px;
        }
        .product-list::-webkit-scrollbar-thumb:hover {
            background: #6ee7b7; /* Brighter Mint */
        }
        .table-cell-ellipsis {
            max-width: 100px; /* Adjust as needed for product name */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
          /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #34d399;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-active {
            overflow-x: hidden;
            overflow-y: auto;
        }
        /* Notification Styles */
        #notificationModal {
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6 md:p-8">
    <div class="container mx-auto max-w-4xl">
        <header class="text-center mb-8 slide-in-up">
            <h1 class="text-4xl sm:text-5xl font-bold text-green-700">üõçÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡πÑ‡∏°‡πâ ü•ïüçì</h1>
        </header>

        <main>
            <!-- Products Table -->
            <section id="products-section" class="mb-8 p-6 bg-white rounded-xl shadow-lg fade-in" style="animation-delay: 0.4s;">
                <h2 class="text-2xl font-semibold text-green-600 mb-4">üõí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</h2>
                <div id="productsLoader" class="loader"></div>
                <div id="productsError" class="hidden text-red-500 text-center p-3 bg-red-100 rounded-lg"></div>
                <div class="overflow-x-auto product-list max-h-[60vh]">
                    <table id="productsTable" class="min-w-full divide-y divide-gray-200 hidden">
                        <thead class="pastel-primary">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs sm:text-sm font-medium text-green-700 uppercase tracking-wider">‡∏†‡∏≤‡∏û üñºÔ∏è</th>
                                <th class="px-4 py-3 text-left text-xs sm:text-sm font-medium text-green-700 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ üìú</th>
                                <th class="px-4 py-3 text-left text-xs sm:text-sm font-medium text-green-700 uppercase tracking-wider">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó) üí∞</th>
                                <th class="px-4 py-3 text-center text-xs sm:text-sm font-medium text-green-700 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ä‡∏∏‡∏î) üî¢</th>
                                <th class="px-4 py-3 text-left text-xs sm:text-sm font-medium text-green-700 uppercase tracking-wider">‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó) üí∏</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Product rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-6 text-right">
                    <!-- Orderer Name Input -->
                    <div id="orderer-section" class="mb-6 p-0 bg-white rounded-xl fade-in" style="animation-delay: 0.2s;">
                        <label for="ordererName" class="block text-lg font-semibold text-gray-700 mb-2 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á üßë‚Äçüåæ:</label>
                        <input type="text" id="ordererName" name="ordererName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-150" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
                    </div>
                    <button id="placeOrderBtn" class="btn-primary font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition duration-300">
                        ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ <span class="ml-1">‚û°Ô∏è</span>
                    </button>
                </div>
            </section>

            <!-- Order History (Summaries Only) -->
            <section id="order-history-section" class="p-6 bg-white rounded-xl shadow-lg fade-in" style="animation-delay: 0.6s;">
                <h2 class="text-2xl font-semibold text-amber-600 mb-4">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
                <div id="ordersLoader" class="loader"></div>
                <div id="ordersError" class="hidden text-red-500 text-center p-3 bg-red-100 rounded-lg"></div>
                
                <!-- Order Summary Section -->
                <div id="ordersSummary" class="mt-6 p-4 bg-yellow-50 rounded-lg shadow-inner hidden">
                    <h3 class="text-xl font-semibold text-amber-700 mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á üìä</h3>
                    <div id="summaryContent" class="space-y-2 mb-6">
                        <!-- Summary items will be inserted here by JavaScript -->
                    </div>

                    <!-- Product Type Summary Section -->
                    <h3 class="text-xl font-semibold text-green-700 mb-3 border-t pt-4 border-gray-200">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏°‡∏ä‡∏ô‡∏¥‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ üçé</h3>
                    <div id="productTypeSummary" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-green-100">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs sm:text-sm font-medium text-green-800 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ üìú</th>
                                    <th class="px-4 py-2 text-right text-xs sm:text-sm font-medium text-green-800 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ üî¢</th>
                                </tr>
                            </thead>
                            <tbody id="productTypeSummaryTableBody" class="bg-white divide-y divide-gray-100">
                                <!-- Product type summary rows will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <button id="refreshOrdersBtn" class="text-sm text-blue-600 hover:text-blue-800 underline">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ üîÑ</button>
                </div>
            </section>
        </main>

        <!-- Order Summary Modal -->
        <div id="orderSummaryModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 opacity-0 pointer-events-none">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 sm:p-8 transform scale-95 transition-all duration-300">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-semibold text-green-700">üìù ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
                    <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div id="modalOrdererName" class="mb-4 text-lg"><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á:</strong> <span class="font-normal"></span></div>
                <div id="modalOrderSummary" class="mb-6 max-h-60 overflow-y-auto">
                    <!-- Summary items will be here -->
                </div>
                <div id="modalGrandTotal" class="text-xl font-bold text-right mb-8">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <span class="text-green-600"></span> ‡∏ö‡∏≤‡∏ó</div>
                <div id="modalError" class="text-red-500 text-sm mb-4 text-center hidden"></div>
                <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-4">
                    <button id="editOrderBtn" class="btn-secondary font-semibold py-2 px-5 rounded-lg w-full sm:w-auto">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    <button id="confirmOrderBtn" class="btn-primary font-semibold py-2 px-5 rounded-lg w-full sm:w-auto">‚úîÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
                </div>
                <div id="confirmOrderLoader" class="loader hidden mt-4"></div>
            </div>
        </div>
        
        <!-- Simple Notification Modal -->
        <div id="notificationModal" class="fixed top-4 right-4 z-[100] p-4 rounded-lg shadow-lg text-white opacity-0 pointer-events-none transition-all duration-500 max-w-xs sm:max-w-sm hidden" style="transform: translateX(100%);">
            <div class="flex items-center">
                <span id="notificationMessage" class="flex-grow"></span>
                <button id="closeNotificationBtn" class="ml-3 text-xl leading-none font-bold hover:text-gray-200">&times;</button>
            </div>
        </div>

        <footer class="text-center mt-12 py-4 text-sm text-gray-500 border-t border-gray-200">
            <p>&copy; <span id="currentYear"></span> ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏ú‡∏±‡∏Å‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏™‡∏î‡πÉ‡∏™. ‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏î‡πÉ‡∏´‡∏°‡πà! üíö</p>
        </footer>

    </div>

    <script>
        // Note: The GAS_URL needs to be updated with your deployed Google Apps Script URL.
        // For testing purposes, you can use a placeholder, but it will not fetch real data.
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzxO-HudmmNyJ58RKhay9oddjboJtrWHSM39Hrj4RL_1fFbZVNowqwP7_c7teiLuiS_/exec'; // REPLACE THIS WITH YOUR ACTUAL DEPLOYED GOOGLE APPS SCRIPT URL
        
        const productsTableBody = document.getElementById('productsTableBody');
        // Removed elements related to individual order history table, as requested
        // const ordersTableBody = document.getElementById('ordersTableBody'); 
        const productsLoader = document.getElementById('productsLoader');
        const ordersLoader = document.getElementById('ordersLoader'); // Kept for summary section loader
        const productsErrorEl = document.getElementById('productsError'); 
        const ordersErrorEl = document.getElementById('ordersError');   // Kept for summary section error
        const productsTable = document.getElementById('productsTable');
        // const ordersTable = document.getElementById('ordersTable'); // Removed
        const ordersSummary = document.getElementById('ordersSummary'); // Element for orderer and product type summaries
        const summaryContent = document.getElementById('summaryContent'); // Element for orderer summary content

        // Elements for product type summary
        const productTypeSummaryElement = document.getElementById('productTypeSummary');
        const productTypeSummaryTableBody = document.getElementById('productTypeSummaryTableBody');

        const ordererNameInput = document.getElementById('ordererName');
        const placeOrderBtn = document.getElementById('placeOrderBtn');
        const refreshOrdersBtn = document.getElementById('refreshOrdersBtn'); // Kept for refreshing summaries

        const modal = document.getElementById('orderSummaryModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const editOrderBtn = document.getElementById('editOrderBtn');
        const confirmOrderBtn = document.getElementById('confirmOrderBtn');
        const modalOrdererName = document.getElementById('modalOrdererName').querySelector('span');
        const modalOrderSummary = document.getElementById('modalOrderSummary');
        const modalGrandTotal = document.getElementById('modalGrandTotal').querySelector('span');
        const modalError = document.getElementById('modalError');
        const confirmOrderLoader = document.getElementById('confirmOrderLoader');
        
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        let productsData = []; // To store fetched products

        // --- Notification System ---
        const notificationModal = document.getElementById('notificationModal');
        const notificationMessage = document.getElementById('notificationMessage');
        const closeNotificationBtn = document.getElementById('closeNotificationBtn');
        let notificationTimeout;

        closeNotificationBtn.addEventListener('click', () => {
            hideNotification();
        });

        /**
         * Displays a notification message.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', or 'info'.
         * @param {number} duration - How long to show the notification in milliseconds (0 for indefinite).
         */
        function showNotification(message, type = 'info', duration = 4000) {
            clearTimeout(notificationTimeout);
            notificationMessage.textContent = message;
            
            // Remove all type classes and hidden, opacity-0, pointer-events-none before adding new ones
            notificationModal.classList.remove('bg-blue-600', 'bg-green-600', 'bg-red-600', 'hidden', 'opacity-0', 'pointer-events-none');
            notificationModal.style.transform = 'translateX(100%)'; // Reset for animation

            requestAnimationFrame(() => {
                if (type === 'success') {
                    notificationModal.classList.add('bg-green-600');
                } else if (type === 'error') {
                    notificationModal.classList.add('bg-red-600');
                } else { // info
                    notificationModal.classList.add('bg-blue-600');
                }

                notificationModal.classList.remove('hidden');
                notificationModal.classList.add('opacity-100');
                notificationModal.style.transform = 'translateX(0)';
                notificationModal.classList.remove('pointer-events-none');
            });
            
            if (duration > 0) {
                notificationTimeout = setTimeout(hideNotification, duration);
            }
        }

        /**
         * Hides the notification message.
         */
        function hideNotification() {
            clearTimeout(notificationTimeout);
            notificationModal.classList.add('opacity-0');
            notificationModal.style.transform = 'translateX(100%)';
            notificationModal.classList.add('pointer-events-none');
            
            setTimeout(() => {
                // Check if still opacity-0 before hiding, to prevent race conditions if shown again quickly
                if (notificationModal.classList.contains('opacity-0')) {
                    notificationModal.classList.add('hidden');
                }
            }, 500); // Match transition duration
        }

        // --- Helper Functions ---
        /**
         * Shows a loader and hides related table/error elements.
         * @param {HTMLElement} loaderElement - The loader element to show.
         * @param {HTMLElement} tableElement - The table element to hide.
         * @param {HTMLElement} errorElement - The error element to hide.
         */
        function showLoader(loaderElement, tableElement, errorElement) {
            if(loaderElement) loaderElement.style.display = 'block';
            // tableElement is now optional as it might not exist for ordersTable
            if(tableElement) tableElement.classList.add('hidden'); 
            if(errorElement) errorElement.classList.add('hidden');
        }

        /**
         * Hides a loader element.
         * @param {HTMLElement} loaderElement - The loader element to hide.
         */
        function hideLoader(loaderElement) {
            if(loaderElement) loaderElement.style.display = 'none';
        }
        
        /**
         * Displays an error message and hides the related table/summary.
         * @param {HTMLElement} errorElement - The error element to show.
         * @param {string} message - The error message.
         * @param {HTMLElement} tableOrSummaryElement - The element (table or summary div) to hide.
         */
        function showError(errorElement, message, tableOrSummaryElement) {
            if(errorElement) {
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
            }
            // tableOrSummaryElement is now optional
            if(tableOrSummaryElement) tableOrSummaryElement.classList.add('hidden');
        }

        /**
         * Hides an error element.
         * @param {HTMLElement} errorElement - The error element to hide.
         */
        function hideError(errorElement) {
             if(errorElement) errorElement.classList.add('hidden');
        }

        /**
         * Formats a number to a fixed 2 decimal places.
         * @param {number|string} price - The price to format.
         * @returns {string} Formatted price string.
         */
        function formatPrice(price) {
            const num = parseFloat(price);
            return isNaN(num) ? '0.00' : num.toFixed(2);
        }
        
        /**
         * Sanitizes HTML string to prevent XSS attacks.
         * @param {string} str - The string to sanitize.
         * @returns {string} Sanitized string.
         */
        function sanitizeHTML(str) {
            if (typeof str !== 'string') str = String(str); 
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        // --- Fetch Products ---
        /**
         * Fetches product data from Google Apps Script.
         */
        async function fetchProducts() {
            showLoader(productsLoader, productsTable, productsErrorEl);
            try {
                const response = await fetch(`${GAS_URL}?action=getProducts`);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText} (Status: ${response.status})`);
                const result = await response.json();
                
                if (!result.success) {
                    console.error("GAS fetchProducts failed. Response from GAS:", result);
                    throw new Error(result.message || 'Failed to fetch products from GAS (Original message from GAS was empty or not provided).');
                }
                
                productsData = result.data;
                renderProducts(productsData);
                hideError(productsErrorEl);
                if (productsTable) productsTable.classList.remove('hidden');

            } catch (error) {
                console.error('Error fetching products:', error); 
                showError(productsErrorEl, `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${error.message} üò≠`, productsTable);
            } finally {
                hideLoader(productsLoader);
            }
        }

        /**
         * Renders product data into the products table.
         * @param {Array<Object>} products - Array of product objects.
         */
        function renderProducts(products) {
            productsTableBody.innerHTML = ''; // Clear existing rows
            if (!products || products.length === 0) {
                productsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">ü•∫ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</td></tr>';
                return;
            }

            products.forEach((product, index) => {
                const name = product['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || 'N/A';
                const price = parseFloat(product['‡∏£‡∏≤‡∏Ñ‡∏≤']);
                // This is where the 'imageUrl' from GAS is used.
                // The GAS script should provide a direct link to the image file (e.g., from Google Drive).
                const imageUrl = product['imageUrl'] || `https://placehold.co/100x100/a7f3d0/333333?text=${encodeURIComponent('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ')}`;
                const unit = product['‡∏´‡∏ô‡πà‡∏ß‡∏¢'] || '‡∏ä‡∏∏‡∏î';

                if (isNaN(price) || price < 0) { // Allow 0 price if intended
                    console.warn('Invalid or zero price for product:', product);
                }

                const row = productsTableBody.insertRow();
                row.classList.add('hover:bg-green-50', 'transition-colors', 'duration-150');
                // The <img> tag displays the image from the imageUrl
                row.insertCell().innerHTML = `<img src="${sanitizeHTML(imageUrl)}" alt="${sanitizeHTML(name)}" class="w-16 h-16 sm:w-20 sm:h-20 object-cover rounded-lg shadow-sm m-1" onerror="this.onerror=null;this.src='https://placehold.co/100x100/fecaca/991b1b?text=${encodeURIComponent('‡∏£‡∏π‡∏õ‡πÄ‡∏™‡∏µ‡∏¢')}';">`;
                
                const nameCell = row.insertCell();
                nameCell.className = 'px-4 py-3 text-sm text-gray-700 table-cell-ellipsis';
                nameCell.title = sanitizeHTML(name); 
                nameCell.innerHTML = `${sanitizeHTML(name)} <span class="text-xs text-gray-500">(${sanitizeHTML(unit)})</span>`;

                row.insertCell().className = 'px-4 py-3 text-sm text-gray-700 text-right sm:text-left';
                row.cells[2].textContent = formatPrice(price);

                const quantityCell = row.insertCell();
                quantityCell.className = 'px-4 py-3 text-sm text-gray-700 text-center';
                const quantitySelect = document.createElement('select');
                quantitySelect.className = 'p-2 border border-gray-300 rounded-md w-20 text-center focus:ring-1 focus:ring-green-500';
                quantitySelect.dataset.productId = product['ID_‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || index; 
                quantitySelect.dataset.productName = name;
                quantitySelect.dataset.productPrice = price;
                for (let i = 0; i <= 10; i++) { 
                    const option = document.createElement('option');
                    option.value = i;
                    option.text = i;
                    quantitySelect.add(option);
                }
                quantitySelect.addEventListener('change', updateTotalItemPrice);
                quantityCell.appendChild(quantitySelect);

                const totalItemPriceCell = row.insertCell();
                totalItemPriceCell.className = 'px-4 py-3 text-sm text-gray-800 font-semibold text-right sm:text-left total-item-price';
                totalItemPriceCell.textContent = '0.00';
            });
        }

        function updateTotalItemPrice(event) {
            const selectElement = event.target;
            const quantity = parseInt(selectElement.value);
            const price = parseFloat(selectElement.dataset.productPrice);
            const totalCell = selectElement.closest('tr').querySelector('.total-item-price');
            totalCell.textContent = formatPrice(quantity * price);
        }

        // --- Fetch Order History (for summaries) ---
        /**
         * Fetches order history from Google Apps Script to generate summaries.
         */
        async function fetchOrders() {
            showLoader(ordersLoader, null, ordersErrorEl); // ordersTable is null as it's removed
            try {
                const response = await fetch(`${GAS_URL}?action=getOrders`);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText} (Status: ${response.status})`);
                const result = await response.json();

                if (!result.success) {
                    console.error("GAS fetchOrders failed. Response from GAS:", result);
                    throw new Error(result.message || 'Failed to fetch orders from GAS (Original message from GAS was empty or not provided).');
                }
                
                renderSummaries(result.data); // Call a new function to render only summaries
                hideError(ordersErrorEl);
                // No ordersTable to show/hide here. ordersSummary handles its own visibility.

            } catch (error) {
                console.error('Error fetching orders for summaries:', error);
                showError(ordersErrorEl, `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ${error.message} üò•`, ordersSummary); // Pass ordersSummary to hide
            } finally {
                hideLoader(ordersLoader);
            }
        }

        /**
         * Renders only the orderer and product type summaries.
         * @param {Array<Object>} orders - Array of order objects.
         */
        function renderSummaries(orders) {
            summaryContent.innerHTML = ''; // Clear existing orderer summary content
            productTypeSummaryTableBody.innerHTML = ''; // Clear existing product type summary content
            ordersSummary.classList.add('hidden'); // Hide summary until data is available

            if (!orders || orders.length === 0) {
                // If no orders, can show a message or just keep summaries hidden.
                // For now, if no orders, just hide the summary section.
                return;
            }

            // Object to store total amounts and ordered items per orderer
            const ordererData = {}; 
            const productTypeTotals = {}; // Object to store total quantities per product type

            orders.forEach(order => {
                const ordererName = order['‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á'] || 'Unknown';
                const productName = order['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || 'Unknown Product';
                const quantityOrdered = parseInt(order['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á'] || 0);
                const currentOrderPrice = parseFloat(order['‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤'] || 0);

                // Aggregate data for orderer summary
                if (!ordererData[ordererName]) {
                    ordererData[ordererName] = {
                        totalPrice: 0,
                        items: []
                    };
                }
                ordererData[ordererName].totalPrice += currentOrderPrice;
                ordererData[ordererName].items.push(`${productName} (${quantityOrdered})`);

                // Aggregate totals for product type summary
                productTypeTotals[productName] = (productTypeTotals[productName] || 0) + quantityOrdered;
            });

            // Render Orderer Summary
            if (Object.keys(ordererData).length > 0) {
                for (const name in ordererData) {
                    const data = ordererData[name];
                    const itemsList = data.items.join(', '); // Join all ordered items for this person
                    const summaryItem = document.createElement('div');
                    summaryItem.className = 'flex flex-col sm:flex-row sm:justify-between sm:items-center text-base py-1 border-b border-gray-100 last:border-b-0';
                    summaryItem.innerHTML = `
                        <span class="font-bold text-gray-800">${sanitizeHTML(name)}</span>
                        <span class="text-sm text-gray-600 sm:ml-4 flex-grow truncate" title="${sanitizeHTML(itemsList)}">(${sanitizeHTML(itemsList)})</span>
                        <span class="font-bold text-green-700 whitespace-nowrap">${formatPrice(data.totalPrice)} ‡∏ö‡∏≤‡∏ó</span>
                    `;
                    summaryContent.appendChild(summaryItem);
                }
            }

            // Render Product Type Summary
            if (Object.keys(productTypeTotals).length > 0) {
                // Sort product names alphabetically for consistent display
                const sortedProductNames = Object.keys(productTypeTotals).sort();
                sortedProductNames.forEach(productName => {
                    const row = productTypeSummaryTableBody.insertRow();
                    row.className = 'bg-white border-b border-gray-200 hover:bg-gray-50';
                    row.insertCell().textContent = sanitizeHTML(productName);
                    row.cells[0].className = 'px-4 py-2 text-sm text-gray-700 font-medium';
                    row.insertCell().textContent = sanitizeHTML(productTypeTotals[productName]);
                    row.cells[1].className = 'px-4 py-2 text-sm text-gray-700 text-right';
                });
            }

            // Show the main summary section if any data is present
            if (Object.keys(ordererData).length > 0 || Object.keys(productTypeTotals).length > 0) {
                ordersSummary.classList.remove('hidden'); 
            }
        }

        // --- Order Placement Logic ---
        placeOrderBtn.addEventListener('click', () => {
            const orderer = ordererNameInput.value.trim();
            if (!orderer) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏∞ üòä', 'error');
                ordererNameInput.focus();
                return;
            }

            const itemsToOrder = [];
            let grandTotal = 0;
            const quantitySelects = productsTableBody.querySelectorAll('select');

            quantitySelects.forEach(select => {
                const quantity = parseInt(select.value);
                if (quantity > 0) {
                    const productName = select.dataset.productName;
                    const productPrice = parseFloat(select.dataset.productPrice);
                    const itemTotalPrice = quantity * productPrice;
                    itemsToOrder.push({
                        productName: productName,
                        price: productPrice,
                        quantity: quantity,
                        itemTotalPrice: itemTotalPrice
                    });
                    grandTotal += itemTotalPrice;
                }
            });

            if (itemsToOrder.length === 0) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞ üß∫', 'error');
                return;
            }

            modalOrdererName.textContent = sanitizeHTML(orderer);
            modalOrderSummary.innerHTML = ''; 
            itemsToOrder.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'py-2 border-b border-gray-200 last:border-b-0 text-sm';
                itemDiv.innerHTML = `<strong>${sanitizeHTML(item.productName)}:</strong> ${item.quantity} x ${formatPrice(item.price)} = <span class="font-semibold">${formatPrice(item.itemTotalPrice)}</span> ‡∏ö‡∏≤‡∏ó`;
                modalOrderSummary.appendChild(itemDiv);
            });
            modalGrandTotal.textContent = formatPrice(grandTotal);
            
            modalError.classList.add('hidden'); 
            confirmOrderLoader.classList.add('hidden');
            confirmOrderBtn.disabled = false;
            editOrderBtn.disabled = false;

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            modal.querySelector('div > div').classList.remove('scale-95'); 
            modal.querySelector('div > div').classList.add('scale-100');
        });

        closeModalBtn.addEventListener('click', () => {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.classList.remove('opacity-100');
            modal.querySelector('div > div').classList.add('scale-95');
        });

        editOrderBtn.addEventListener('click', () => {
            closeModalBtn.click(); 
        });

        confirmOrderBtn.addEventListener('click', async () => {
            const orderer = ordererNameInput.value.trim();
            const itemsToOrder = [];
            
            productsTableBody.querySelectorAll('select').forEach(select => {
                const quantity = parseInt(select.value);
                if (quantity > 0) {
                    itemsToOrder.push({
                        productName: select.dataset.productName,
                        quantity: quantity,
                        itemTotalPrice: parseFloat(select.dataset.productPrice) * quantity
                    });
                }
            });
            
            if (itemsToOrder.length === 0) { 
                modalError.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠';
                modalError.classList.remove('hidden');
                return;
            }
            
            const payload = {
                ordererName: orderer,
                items: itemsToOrder
            };

            confirmOrderLoader.classList.remove('hidden');
            confirmOrderBtn.disabled = true;
            editOrderBtn.disabled = true;
            modalError.classList.add('hidden');

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: {
                        'Content-Type': 'text/plain', 
                    },
                });
                
                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    const textResponse = await response.text();
                    console.error("Failed to parse server response as JSON. Raw response:", textResponse);
                    throw new Error(`Failed to parse server response. Status: ${response.status}. Response: ${textResponse.substring(0,100)}...`);
                }

                if (!response.ok || !result.success) {
                    console.error("GAS confirmOrder failed. Response from GAS:", result);
                    throw new Error(result.message || `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (HTTP ${response.status})`);
                }

                showNotification('üéâ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞! ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞ üôè', 'success');
                closeModalBtn.click();
                ordererNameInput.value = ''; 
                productsTableBody.querySelectorAll('select').forEach(select => {
                    select.value = '0';
                    select.dispatchEvent(new Event('change')); 
                });
                fetchOrders(); // Re-fetch summaries after a successful order

            } catch (error) {
                console.error('Error confirming order:', error);
                modalError.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
                modalError.classList.remove('hidden');
                // Also show notification for broader visibility
                showNotification(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ${error.message}`, 'error', 6000);
            } finally {
                confirmOrderLoader.classList.add('hidden');
                confirmOrderBtn.disabled = false;
                editOrderBtn.disabled = false;
            }
        });
        
        refreshOrdersBtn.addEventListener('click', fetchOrders);

        // --- Initial Load ---
        // Fetches products and orders when the page loads.
        fetchProducts();
        fetchOrders(); // Fetch summaries on initial load

    </script>
</body>
</html>
